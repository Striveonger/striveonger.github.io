(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{498:function(t,s,a){t.exports=a.p+"assets/img/node-linux_012.7430ed2b.jpg"},769:function(t,s,a){"use strict";a.r(s);var e=a(0),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("我本来想用Docker, 组个局域网的. 原来公司就是这么玩的. 结果了解到MacOS和Linux的Docker实现不一样. Docker for Mac 用了一个虚拟机, 把Docker包起来提供服务, 所以在Mac下不能直接访问Docker容器.")]),t._v(" "),s("p",[t._v("我的解决方案: 在Mac上安装虚拟机, 在虚拟机中安装Docker. 然后用虚拟机做路由转发. 连通Mac与Docker.")]),t._v(" "),s("h4",{attrs:{id:"准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准备"}},[t._v("#")]),t._v(" 准备")]),t._v(" "),s("ul",[s("li",[s("p",[s("a",{attrs:{href:"https://www.virtualbox.org/wiki/Downloads",target:"_blank",rel:"noopener noreferrer"}},[t._v("VirtualBox - v5.2.2"),s("OutboundLink")],1),t._v("：虚拟机")])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://www.vagrantup.com/downloads.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Vagrant - v2.0.1"),s("OutboundLink")],1),t._v("：通过配置文件来快速创建定制的虚拟机")])])]),t._v(" "),s("h4",{attrs:{id:"安装虚拟机"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装虚拟机"}},[t._v("#")]),t._v(" 安装虚拟机")]),t._v(" "),s("blockquote",[s("p",[s("a",{attrs:{href:"https://github.com/tommy-muehle/puppet-vagrant-boxes/releases/download/1.1.0/centos-7.0-x86_64.box",target:"_blank",rel:"noopener noreferrer"}},[t._v("下载虚拟机镜像"),s("OutboundLink")],1),t._v(" : CentOS 7")])]),t._v(" "),s("blockquote",[s("p",[t._v("移动到工作空间:  "),s("code",[t._v("mv ~/Downloads/centos-7.0-x86_64.box ~/development/workspace/vm/box/")])])]),t._v(" "),s("blockquote",[s("p",[t._v("添加镜像: "),s("code",[t._v("vagrant box add centos7 ~/development/workspace/vm/box/centos-7.0-x86_64.box")])])]),t._v(" "),s("blockquote",[s("p",[t._v("进入vagrant工作空间: "),s("code",[t._v("cd ~/development/workspace/vm/vagrant/centos")])])]),t._v(" "),s("blockquote",[s("p",[t._v("初始化镜像: "),s("code",[t._v("vagrant init centos7")])])]),t._v(" "),s("blockquote",[s("p",[t._v("配置虚拟机:  "),s("code",[t._v("vim Vagrantfile")])])]),t._v(" "),s("div",{staticClass:"language-ruby line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-ruby"}},[s("code",[t._v("Vagrant"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("configure"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n  config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("box "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"centos7"')])]),t._v("\n  config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hostname "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"centos7"')])]),t._v("\n  config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("network "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"private_network"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token symbol"}},[t._v("ip")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.13.144.104"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token symbol"}},[t._v("netmask")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"255.255.255.0"')])]),t._v("\n\n  config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("provider "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"virtualbox"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("v"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"centos7"')])]),t._v("\n    v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memory "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1024"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])]),s("blockquote",[s("p",[t._v("启动虚拟机: "),s("code",[t._v("vagrant up")])])]),t._v(" "),s("blockquote",[s("p",[t._v("进入虚拟机: "),s("code",[t._v("vagrant ssh")])])]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("passwd")]),t._v(" root\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("su")]),t._v(" root\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" ~\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" .ssh\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" .ssh\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" authorized_keys\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("blockquote",[s("p",[t._v("使用SSH登录虚拟机: "),s("code",[t._v("ssh root@10.13.144.104")])])]),t._v(" "),s("h4",{attrs:{id:"在虚拟机中安装docker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在虚拟机中安装docker"}},[t._v("#")]),t._v(" 在虚拟机中安装Docker")]),t._v(" "),s("blockquote",[s("p",[t._v("安装Docker: "),s("code",[t._v("yum -y install docker")])])]),t._v(" "),s("blockquote",[s("p",[t._v("创建容器: "),s("code",[t._v('docker run --name=linux -d centos:6.7 /bin/bash -c "while true; do echo hello; sleep 1; done"')])])]),t._v(" "),s("blockquote",[s("p",[t._v("出错了:")])]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("/usr/bin/docker-current: Error response from daemon: error creating overlay "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mount")]),t._v(" to /var/lib/docker/overlay2/65f3c109fb903539820f84856d2725af784f2f03f95b1f0214e34184e4d61ff7-init/merged: invalid argument.\nSee "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/usr/bin/docker-current run --help'")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("在网上搜索一番后，一个可行的方案如下(改变storage driver类型， 禁用"),s("a",{attrs:{href:"https://www.centos.bz/tag/selinux/",target:"_blank",rel:"noopener noreferrer"}},[t._v("selinux"),s("OutboundLink")],1),t._v("):")]),t._v(" "),s("blockquote",[s("p",[t._v("停止docker服务: "),s("code",[t._v("systemctl stop docker")])])]),t._v(" "),s("blockquote",[s("p",[t._v("清理镜像: "),s("code",[t._v("rm -rf /var/lib/docker")])])]),t._v(" "),s("blockquote",[s("p",[t._v("修改存储类型: vi "),s("code",[t._v("/etc/sysconfig/docker-storage")])])]),t._v(" "),s("blockquote",[s("p",[t._v("把空的DOCKER_STORAGE_OPTIONS参数改为overlay:  "),s("code",[t._v('DOCKER_STORAGE_OPTIONS="--storage-driver overlay"')])])]),t._v(" "),s("blockquote",[s("p",[t._v("禁用selinux: "),s("code",[t._v("vi /etc/sysconfig/docker")]),t._v(" 去掉option的 "),s("code",[t._v("–selinux-enabled")])])]),t._v(" "),s("blockquote",[s("p",[t._v("启动docker应该就可以了: "),s("code",[t._v("systemctl start docker")])])]),t._v(" "),s("blockquote",[s("p",[t._v("重新创建容器: "),s("code",[t._v('docker run --name=linux -d centos:6.7 /bin/bash -c "while true; do echo hello; sleep 1; done"')])])]),t._v(" "),s("blockquote",[s("p",[t._v("查看容器信息")])]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@centos7 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker ps")]),t._v("\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\nb3c81e022a22        centos:6.7          "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/bin/bash -c \'whi..."')]),t._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v(" seconds ago       Up "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" seconds                            linux\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@centos7 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker inspect --format '{{ .NetworkSettings.IPAddress }}' b3c81e022a22")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.17")]),t._v(".0.2\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@centos7 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ping 172.17.0.2")]),t._v("\nPING "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.17")]),t._v(".0.2 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.17")]),t._v(".0.2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("56")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("84")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" bytes of data.\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" bytes from "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.17")]),t._v(".0.2: "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("icmp_seq")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ttl")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("time")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.075")]),t._v(" ms\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" bytes from "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.17")]),t._v(".0.2: "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("icmp_seq")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ttl")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("time")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.076")]),t._v(" ms\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("h4",{attrs:{id:"现在的网络拓扑图"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#现在的网络拓扑图"}},[t._v("#")]),t._v(" 现在的网络拓扑图")]),t._v(" "),s("p",[s("img",{attrs:{src:a(498),alt:"node-linux_012"}})]),t._v(" "),s("blockquote",[s("p",[t._v("A 是我的MacBook, B 是我安装的虚拟机, C 和 D 是虚拟机中安装的Docker容器.")])]),t._v(" "),s("p",[t._v("A添加静态路由，让特定地址或者网断流量路由到B，然后 B开启内核转发，同时调整 iptable forward 链规则")]),t._v(" "),s("p",[t._v("结果到这就不会弄了......")]),t._v(" "),s("p",[t._v("想哭........")]),t._v(" "),s("h4",{attrs:{id:"注-vagrant命令详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注-vagrant命令详解"}},[t._v("#")]),t._v(" 注: Vagrant命令详解")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[t._v("命令")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("作用")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant box add")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("添加box的操作")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant init")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("初始化box的操作，会生成vagrant的配置文件Vagrantfile")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant up")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("启动本地环境")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant ssh")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("通过ssh登录本地环境所在虚拟机")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant halt")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("关闭本地环境")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant suspend")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("暂停本地环境")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant resume")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("恢复本地环境")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant reload")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("修改了Vagrantfile后，使之生效（相当于先 halt，再 up）")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant destroy")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("彻底移除本地环境")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant box list")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("显示当前已经添加的box列表")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant box remove")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("删除相应的box")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant package")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("打包命令，可以把当前的运行的虚拟机环境进行打包")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant plugin")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("用于安装卸载插件")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant status")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("获取当前虚拟机的状态")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("vagrant global-status")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("显示当前用户Vagrant的所有环境状态")])])])])])}),[],!1,null,null,null);s.default=n.exports}}]);